name: "Run `nox` sessions"

on: [pull_request]

jobs:
  nox:
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest]
        python: ["3.10", "3.11"]
        nox_session: ["docs", "example", "pre-commit", "testing"]
        exclude:
          - os: macos-latest
            nox_session: "docs"
          - os: macos-latest
            nox_session: "pre-commit"
          - python: "3.10"
            nox_session: "docs"
          - python: "3.10"
            nox_session: "pre-commit"
      fail-fast: true
    name: ${{ matrix.os }} / ${{ matrix.python }} / ${{ matrix.nox_session }}
    runs-on: ${{ matrix.os }}
    defaults:
      run:
        shell: bash

    steps:
      - name: Checkout the revision
        uses: actions/checkout@v4

      - name: Install Poetry
        id: install-poetry
        uses: ./.github/actions/install-poetry
        with:
          python-version: ${{ matrix.python }}

      - name: Cache Poetry virtual environment
        uses: actions/cache@v4
        id: cache
        with:
          path: .venv
          key: cache-${{ github.repository }}-main-${{ github.job }}-poetry-venv-${{ runner.os }}-${{ steps.install-poetry.outputs.full-python-version }}-${{ hashFiles('poetry.lock') }}
          restore-keys: cache-${{ github.repository }}-main-${{ github.job }}-poetry-venv-${{ runner.os }}-${{ steps.install-poetry.outputs.full-python-version }}-

      - name: Install dependencies
        if: ${{ steps.cache.outputs.cache-hit != 'true' }}
        run: poetry install --with=ci-cd --sync --no-ansi --no-root

      - name: Run `nox` session `${{ matrix.nox_session }}`
        run: poetry run nox --force-python python --session ${{ matrix.nox_session }}
